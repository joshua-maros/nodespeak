image: alpine

stages:
  - check
  - build
  - document
  - check_artifacts
  - publish
  - pages

check:
  stage: check
  image: rust:1.37
  script: 
    - cargo install llvmenv
    - llvmenv build-entry 7.0.0
    - cargo test
  only: 
    - master
    - merge_requests
  
build:
  stage: build 
  image: rust:1.37
  script: 
    - cargo install llvmenv
    - llvmenv build-entry 7.0.0
    - cargo build --release
  only: 
  - master
  - merge_requests
  artifacts:
    paths: 
    - target/release/nodespeak
    expire_in: 30 minutes
  
document:
  stage: document
  image: rustlang/rust:nightly
  script: cargo doc
  only: 
  - master
  - merge_requests
  artifacts:
    paths:
    - target/doc
    expire_in: 30 minutes

check_artifacts:
  stage: check_artifacts
  dependencies: 
  - build
  - document
  script: 
  - test -e target/release/nodespeak
  - test -e target/doc
  only:
  - merge_requests

publish:
  stage: publish
  dependencies: 
  - build
  - document
  script: 
  - mv target/release/nodespeak nodespeak
  - mv target/doc pages
  only: 
  - master
  artifacts:
    paths:
    - nodespeak
    - pages

pages:
  stage: pages 
  dependencies:
  - publish
  script:
  - mv pages public
  only: 
  - master
  artifacts:
    paths:
    - public
